Описание функционала

1. Классы и База Данных

Мы имеем несколько моделей для работы с базой данных:
	•	Модель Accounts: Описание аккаунтов, таких как имя, фамилия, номер телефона и состояние аккаунта. Эта модель также содержит связь с прокси-серверами (через внешний ключ).
	•	Модель Proxy: Хранит информацию о прокси-серверах, включая IP-адрес, логин и пароль.
	•	Модель Channels: Содержит информацию о каналах, в том числе название канала, статус канала (открытый или закрытый), количество заявок и принятых заявок, а также комментарий, который используется для генерации комментариев через OpenAI.
	•	Модель Actions: Описание действий, которые должны быть выполнены для канала. Это может быть комментарий, реакция или просмотр. Каждое действие связано с конкретным каналом. Также указывается время выполнения действия и разброс времени в процентах.

2. Логика выполнения действий

Ключевая часть кода — это класс BotActionExecutor, который отвечает за выполнение действий для ботов (аккаунтов). Вот его ключевые функции:
	•	Метод random_time_with_spread: Этот метод генерирует случайное время с учетом разброса. Например, если время выполнения действия — 60 минут, а разброс составляет 20%, результат будет в пределах от 48 до 72 минут.
	•	Метод run: Этот метод запускает выполнение действия для всех каналов, связанных с конкретным действием в базе данных. Он также ищет все сессии в папке с сессиями и выполняет действия для каждого аккаунта (бота). Для каждого канала в базе данных будет выполнено действие (например, комментарий или реакция).
	•	Метод execute_for_session: Для каждого найденного файла сессии в папке sessions (которые соответствуют номерам телефонов) создается новый клиент Pyrogram (Client). Для этого клиента выполняется действие, которое указано в базе данных для канала.
	•	Методы execute_comment, execute_reaction, execute_view: Эти методы отвечают за выполнение конкретных типов действий:
	•	execute_comment — генерирует комментарий с помощью сервиса OpenAI и отправляет его в указанный канал.
	•	execute_reaction — ставит случайные реакции на посты в канале.
	•	execute_view — выполняет действия по просмотру постов в канале.

3. Интеграция с OpenAI

Для генерации комментариев используется OpenAIService, который отвечает за создание текста комментариев с использованием модели GPT-3 или аналогичной. Сервис принимает шаблон комментария и генерирует на его основе текст.

4. Работа с сессиями

Каждый файл в папке с сессиями представляет собой отдельную сессию Telegram для бота, где имя файла соответствует номеру телефона, например, +1234567890.session. Когда мы проходим по папке с сессиями, для каждой сессии создается новый клиент Pyrogram (Client). Этот клиент используется для выполнения действий от имени соответствующего бота.

5. Запуск выполнения действий через HTTP-запросы (FastAPI)

Для интеграции с веб-API мы написали роут, который запускает выполнение действий для всех сессий и каналов, связанных с этим действием:
	•	Роут /execute-action: Когда поступает запрос с ID действия, API-ключами и другими параметрами, система выполняет следующее:
	•	Находит все каналы, связанные с этим действием.
	•	Проходит по всем сессиям в папке sessions и для каждой сессии выполняет действие, определенное в базе данных для соответствующего канала.
	•	В зависимости от типа действия (комментарий, реакция или просмотр) выполняется соответствующая логика для каждого канала.

6. Обработка ошибок и состояния

В случае ошибок, например, если не удалось найти канал или аккаунт для выполнения действия, код просто пропускает эти случаи и продолжает работать с другими канала и сессиями.

Принцип работы системы
	1.	Запрос: Вы отправляете запрос на выполнение действия через FastAPI. Этот запрос содержит ID действия, API-ключи для доступа к Telegram и другие параметры.
	2.	База данных: Система извлекает информацию о действиях и каналах из базы данных. Это может быть, например, запрос на выполнение 10 комментариев на определенном канале.
	3.	Сессии Telegram: Все сессии Telegram хранятся в папке sessions, и каждый файл в этой папке соответствует отдельному боту, который может выполнять действия от имени пользователя.
	4.	Выполнение действия: Для каждой сессии создается объект клиента Pyrogram, и для каждого канала выполняется действие. В зависимости от типа действия (комментарий, реакция, просмотр) бот будет генерировать соответствующие действия и выполнять их.
	5.	Завершение: После выполнения действия результат возвращается через API (например, “Action executed successfully”).